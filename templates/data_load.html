{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">

    <h3 class="text-center mb-4">Load CSV Data</h3>

    <!-- Upload form -->
    <form id="csvForm" method="post" enctype="multipart/form-data"
          class="card p-4 shadow-sm mb-4">
        {% csrf_token %}

        <div class="mb-3">
            <label for="csvFile" class="form-label">Select CSV file</label>
            <input
                class="form-control"
                type="file"
                id="csvFile"
                name="csvFile"
                accept=".csv"
                required
            >
        </div>

        <div class="d-flex gap-3 justify-content-center">
            <button type="button" id="previewBtn" class="btn btn-outline-primary">
                Preview
            </button>
            <button type="submit" class="btn btn-primary">
                Load data
            </button>
        </div>
    </form>

    <!-- Preview -->
    <div id="previewContainer" style="display:none;">
        <h5 class="mb-3">CSV Preview (first rows)</h5>

        <div class="table-responsive">
            <table class="table table-sm table-bordered" id="previewTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.getElementById('previewBtn').addEventListener('click', function () {
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];

        if (!file) {
            alert('Please select a CSV file first.');
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const rows = e.target.result
                .split('\n')
                .filter(r => r.trim().length > 0)
                .map(row => row.split(','));

            const thead = document.querySelector('#previewTable thead');
            const tbody = document.querySelector('#previewTable tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Header
            const headerRow = document.createElement('tr');
            rows[0].forEach(h => {
                const th = document.createElement('th');
                th.textContent = h.trim();
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // First 5 rows
            rows.slice(1, 6).forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell.trim();
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            document.getElementById('previewContainer').style.display = 'block';
        };

        reader.readAsText(file);
    });
</script>
{% endblock %}
